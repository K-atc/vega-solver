from ..AST import Eq, Not
from ..Writer import FileWriter, StringWriter

class SmtlibCapability:

    ### serialize constraints with z3 compatibility
    def to_smt2(self, file=None):
        if file:
            out = FileWriter(file)
        else:
            out = StringWriter()

        out.write("; generated by vega")
        out.write("(set-info :status unknown)")

        ### Collect sorts
        sorts = set()
        for v in self.variables.keys():
            sorts.add(v.sort)

        ### Define domain
        out.write("(declare-datatypes () (({} {})))".format(self.domain.name, ' '.join(["({})".format(x) for x in self.domain.values])))
        for v in self.domain.values: # reffers domain.values to avoid redefine symbols (e.g. a of sort s, a of sort t)
            out.write("; (declare-fun {} () {})".format(v.name, self.domain.name))

        ### Define sorts
        for sort in sorts: # TODO
            out.write("(declare-datatypes () (({} {})))".format(sort.name, ' '.join(["({})".format(x) for x in sort.values])))

        ### Define all variables with same domain (sort)
        for v in self.variables.keys():
            out.write("(declare-fun {} () {})".format(v.name, self.domain.name))
        
        for expr in self.constraints:
            out.write("(assert\n {})".format(expr.to_smt2()))

        ### Restrict values
        for v in self.variables.keys():
            if v.sort != self.domain: # e.g. sort FileContent
                for value in self.domain.values - v.sort.values:
                    out.write("(assert\n {})".format(Not(Eq(v, value)).to_smt2()))

        out.write("(check-sat)")
        
        return out.finalize()